<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey on Capsule Coffee Machines</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
           background:#fafafa; color:#111; max-width:860px; margin:0 auto; padding:24px; }
    .sec { background:#fff; border:1px solid #ececec; border-radius: 12px; padding: 18px; margin: 16px 0; }
    .q { margin: 14px 0; }
    .q b { display:block; margin-bottom:8px; }
    label { display:block; padding:6px 0; }
    .muted { color:#666; font-size:.92rem; }
    button { padding: 12px 18px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
    .hide{display:none} .ok{color:#0a7e07} .err{color:#b00020}
    input[type="text"]{ padding:6px 8px; border:1px solid #ddd; border-radius:8px; }
  </style>
</head>
<body>
<h1>Survey on Capsule Coffee Machines</h1>
<p><b>Purpose:</b> This survey is part of a product research study to understand coffee habits and desired features for capsule coffee machines.
   <b>Duration:</b> About 4–6 minutes. <b>Anonymity:</b> No personal identifying information is collected; results are analyzed in aggregate only.</p>

<!-- Quick connectivity test -->
<div class="sec">
  <h2>Quick Test (Ping)</h2>
  <p class="muted">Click to send a test row to your Google Sheet (via GET). If you don't see a <b>PING</b> row in the sheet, your Web App URL or permissions are wrong.</p>
  <button id="pingBtn">Send a test ping</button>
  <span id="pingMsg" class="muted"></span>
</div>

<!-- Section 1 -->
<div class="sec">
  <h2>Section 1: Your Coffee Habits</h2>

  <div class="q">
    <b>Q1. How many cups of coffee do you typically drink per day? <span class="muted">*</span></b>
    <label><input type="radio" name="q1" value="None"> None</label>
    <label><input type="radio" name="q1" value="1-2 cups"> 1–2 cups</label>
    <label><input type="radio" name="q1" value="3-4 cups"> 3–4 cups</label>
    <label><input type="radio" name="q1" value="5 or more cups"> 5 or more cups</label>
  </div>

  <div class="q">
    <b>Q2. Where do you typically drink coffee? (Select all that apply) <span class="muted">*</span></b>
    <label><input type="checkbox" name="q2" value="At home"> At home</label>
    <label><input type="checkbox" name="q2" value="At the office"> At the office</label>
    <label><input type="checkbox" name="q2" value="At a coffee shop"> At a coffee shop</label>
    <label><input type="checkbox" name="q2" value="On the go"> On the go</label>
  </div>

  <div class="q">
    <b>Q3. What types of coffee beverages do you enjoy most? (Select up to 3) <span class="muted">*</span></b>
    <label><input type="checkbox" name="q3" value="Black coffee (Americano, filter)"> Black coffee (Americano, filter)</label>
    <label><input type="checkbox" name="q3" value="Espresso"> Espresso</label>
    <label><input type="checkbox" name="q3" value="Latte"> Latte</label>
    <label><input type="checkbox" name="q3" value="Cappuccino"> Cappuccino</label>
    <label><input type="checkbox" name="q3" value="Iced coffee"> Iced coffee</label>
    <label><input type="checkbox" name="q3" value="Flavored coffee (e.g., vanilla, caramel)"> Flavored coffee (e.g., vanilla, caramel)</label>
    <label><input type="checkbox" name="q3" value="Other"> Other (please specify): <input type="text" id="q3_other" placeholder="Specify"/></label>
    <div class="muted">Please select no more than 3 options.</div>
  </div>
</div>

<!-- Section 2 -->
<div class="sec">
  <h2>Section 2: Your Current Coffee Machine</h2>

  <div class="q">
    <b>Q4. Do you currently own a coffee machine? <span class="muted">*</span></b>
    <label><input type="radio" name="q4" value="Yes"> Yes</label>
    <label><input type="radio" name="q4" value="No"> No</label>
    <div class="muted">If No, you may skip Q5–Q8.</div>
  </div>

  <div class="q">
    <b>Q5. What type of coffee machine do you like?</b>
    <label><input type="radio" name="q5" value="Capsule/pod coffee machine"> Capsule/pod coffee machine</label>
    <label><input type="radio" name="q5" value="Drip coffee maker"> Drip coffee maker</label>
    <label><input type="radio" name="q5" value="Espresso machine (manual/semi-automatic)"> Espresso machine (manual/semi-automatic)</label>
    <label><input type="radio" name="q5" value="Bean-to-cup machine"> Bean-to-cup machine</label>
    <label><input type="radio" name="q5" value="Multiple capsule coffee machine"> Multiple capsule coffee machine</label>
    <label><input type="radio" name="q5" value="Other"> Other (please specify): <input type="text" id="q5_other" placeholder="Specify"/></label>
  </div>

  <div class="q">
    <b>Q6. If you own a capsule coffee machine, which brand is it?</b>
    <label><input type="radio" name="q6" value="Nespresso"> Nespresso</label>
    <label><input type="radio" name="q6" value="Keurig"> Keurig</label>
    <label><input type="radio" name="q6" value="Tassimo"> Tassimo</label>
    <label><input type="radio" name="q6" value="Dolce Gusto"> Dolce Gusto</label>
    <label><input type="radio" name="q6" value="Other"> Other (please specify): <input type="text" id="q6_other" placeholder="Specify"/></label>
    <label><input type="radio" name="q6" value="I don't own a capsule machine"> I don't own a capsule machine</label>
  </div>

  <div class="q">
    <b>Q7. How satisfied are you with your current coffee machine? (1 = Very Dissatisfied, 5 = Very Satisfied)</b>
    <label><input type="radio" name="q7" value="1"> 1</label>
    <label><input type="radio" name="q7" value="2"> 2</label>
    <label><input type="radio" name="q7" value="3"> 3</label>
    <label><input type="radio" name="q7" value="4"> 4</label>
    <label><input type="radio" name="q7" value="5"> 5</label>
  </div>

  <div class="q">
    <b>Q8. What are the main pain points with your current home coffee maker? (Select all that apply)</b>
    <label><input type="checkbox" name="q8" value="Milk system is hard to clean"> Milk system is hard to clean</label>
    <label><input type="checkbox" name="q8" value="Need to descale frequently (limescale)"> Need to descale frequently (limescale)</label>
    <label><input type="checkbox" name="q8" value="Too noisy"> Too noisy</label>
    <label><input type="checkbox" name="q8" value="Takes up too much space"> Takes up too much space</label>
    <label><input type="checkbox" name="q8" value="First cup takes too long"> First cup takes too long</label>
    <label><input type="checkbox" name="q8" value="Taste is inconsistent"> Taste is inconsistent</label>
    <label><input type="checkbox" name="q8" value="Pods/capsules are expensive"> Pods/capsules are expensive</label>
    <label><input type="checkbox" name="q8" value="Reliability/repairs"> Reliability/repairs</label>
    <label><input type="checkbox" name="q8" value="Other"> Other (please specify): <input type="text" id="q8_other" placeholder="Specify"/></label>
    <label><input type="checkbox" name="q8" value="None of the above"> None of the above</label>
  </div>
</div>

<!-- Section 3 -->
<div class="sec">
  <h2>Section 3: Desired Features in a New Capsule Coffee Machine</h2>
  <p class="muted">Best-only choice: In each question, select the ONE most important feature.</p>
  <div id="bestonly"></div>
</div>

<!-- Section 4 -->
<div class="sec">
  <h2>Section 4: Price</h2>
  <div class="q">
    <b>Q10. How much would you be willing to spend on a new capsule coffee machine with your desired features?</b>
    <label><input type="radio" name="q10" value="Under $100"> Under $100</label>
    <label><input type="radio" name="q10" value="$100 - $199"> $100 – $199</label>
    <label><input type="radio" name="q10" value="$200 - $299"> $200 – $299</label>
    <label><input type="radio" name="q10" value="$300 - $399"> $300 – $399</label>
    <label><input type="radio" name="q10" value="$400 or more"> $400 or more</label>
  </div>
  <div class="q">
    <b>Q11. How much extra would you be willing to pay for a machine with advanced smart features (e.g., app control, voice commands)?</b>
    <label><input type="radio" name="q11" value="$0">$0</label>
    <label><input type="radio" name="q11" value="$10 - $29">$10 – $29</label>
    <label><input type="radio" name="q11" value="$30 - $49">$30 – $49</label>
    <label><input type="radio" name="q11" value="$50 or more">$50 or more</label>
  </div>
</div>

<div class="sec">
  <button id="submitBtn">Submit</button>
  <span id="msg" class="muted"></span>
  <p id="ok" class="ok hide">Thanks! Your response has been recorded.</p>
  <p id="err" class="err hide">Submit failed. Please try again later.</p>
</div>

<script>
// ============== CONFIG ==============
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxYh_ZT9--AJ_3mVB1VuCBDBB4bxN5sbtjI08A6ql4A3t8WaN4_8XwBPHqiYFvlXL-hRA/exec'; // <- 部署好后替换成你的 /exec

// 固定的 4 题（每个功能出现两次），题内顺序对每位受访者随机
const TASKS = [
  ['A','B','C','D'], // Q9-1
  ['E','F','G','H'], // Q9-2
  ['A','E','G','C'], // Q9-3
  ['B','F','H','D']  // Q9-4
];
const ITEMS = {
  'A':'Adjustable brew strength',
  'B':'Adjustable temperature control',
  'C':'Multiple cup size options',
  'D':'Programmable / saved preferences',
  'E':'Fast heat-up time',
  'F':'Automatic pod disposal',
  'G':'Large water reservoir',
  'H':'Adjustable spout for different cups'
};

// ============== RENDER Q9 BLOCKS ==============
const wrap = document.getElementById('bestonly');
TASKS.forEach((arr, i) => {
  const shuffled = arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const qid = `q9_${i+1}`;
  const div = document.createElement('div');
  div.className = 'q';
  div.innerHTML = `<b>Q9-${i+1}. Which ONE feature is the most important to you?</b>` +
    shuffled.map(o=>`<label><input type="radio" name="${qid}" value="${o}"> ${o}. ${ITEMS[o]}</label>`).join('');
  wrap.appendChild(div);
});

// ============== HELPERS ==============
function getRadio(name){ const el=document.querySelector(`input[name="${name}"]:checked`); return el?el.value:''; }
function getChecks(name){ return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(x=>x.value); }
function uid(){ const k='survey_uid'; let v=localStorage.getItem(k); if(!v){ v='u_'+Math.random().toString(36).slice(2)+Date.now().toString(36); localStorage.setItem(k,v);} return v; }
function limitCheckbox(name, max){
  const boxes = Array.from(document.querySelectorAll(`input[name="${name}"]`));
  boxes.forEach(b=>b.addEventListener('change', ()=>{
    const picked = boxes.filter(x=>x.checked);
    if(picked.length>max){ b.checked=false; }
  }));
}
limitCheckbox('q3', 3);

// ============== SUBMIT ==============
async function postJSON(url, obj){
  // 用 text/plain 避免 CORS 预检；GAS 端仍可 JSON.parse 读取
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(obj)
  });
  try { return await res.json(); } catch(e){ return {ok:true, opaque:true}; }
}

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const must = (v)=>v && (Array.isArray(v)?v.length>0:true);

  const payload = {
    uid: uid(),
    q1:   getRadio('q1'),
    q2:   getChecks('q2'),
    q3:   getChecks('q3'),
    q4:   getRadio('q4'),
    q5:   getRadio('q5') || '',
    q6:   getRadio('q6') || '',
    q7:   getRadio('q7') || '',
    q8:   getChecks('q8') || [],
    q9_1: getRadio('q9_1'),
    q9_2: getRadio('q9_2'),
    q9_3: getRadio('q9_3'),
    q9_4: getRadio('q9_4'),
    q10:  getRadio('q10') || '',
    q11:  getRadio('q11') || '',
    ts: new Date().toISOString()
  };

  // 必答校验：Q1、Q2、Q3(≤3)、Q9-1~4
  const ok_required = must(payload.q1) && must(payload.q2) && must(payload.q3)
                   && must(payload.q9_1) && must(payload.q9_2) && must(payload.q9_3) && must(payload.q9_4);
  const msg = document.getElementById('msg');
  if(!ok_required){ msg.textContent = 'Please complete required questions: Q1–Q3 and Q9-1~Q9-4.'; return; }
  if(payload.q3.length>3){ msg.textContent = 'Q3: select no more than 3 options.'; return; }
  msg.textContent = 'Submitting...';

  try{
    await postJSON(GAS_WEB_APP_URL, payload);
    document.getElementById('ok').classList.remove('hide');
    msg.textContent = '';
    document.getElementById('submitBtn').disabled = true;
  }catch(e){
    document.getElementById('err').classList.remove('hide');
    msg.textContent = '';
  }
});

// ============== PING (GET) ==============
document.getElementById('pingBtn').addEventListener('click', async ()=>{
  const u = GAS_WEB_APP_URL + '?ping=1&uid=' + encodeURIComponent(uid());
  try{
    await fetch(u, {method:'GET'});
    document.getElementById('pingMsg').textContent = 'Ping sent. Check your sheet for a new row labeled [PING].';
  }catch(e){
    document.getElementById('pingMsg').textContent = 'Ping failed (check /exec URL & permissions).';
  }
});
</script>
</body>
</html>
